# CFG LOADBALANCER VIP STORE PROJECT 
# Diperbaiki untuk HAProxy 2.8+ (Ubuntu 24.04)

global
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    user haproxy
    group haproxy
    daemon
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    option  dontlognull
    timeout connect 5s
    timeout client  60s
    timeout server  60s

# ========== SSH-WS (raw TCP over SSL)
frontend ssh_ws_front
    mode tcp
    bind *:8080
    bind *:8443 ssl crt /etc/xray/xray.pem alpn h2,http/1.1
    default_backend ssh_ws_back

backend ssh_ws_back
    mode tcp
    server ssh_ws_ku 127.0.0.1:10015
    
# ========== SSH Stunnel (SSL on 444)
frontend ssh_stunnel_front
    mode tcp
    bind *:444 ssl crt /etc/xray/xray.pem
    default_backend ssh_stunnel_back

backend ssh_stunnel_back
    mode tcp
    server dropbear_server 127.0.0.1:143

# ========== Xray WS/GRPC - HTTP clear
frontend http_front
    mode http
    bind *:80,*:8880,*:2052,*:2086,*:2095
    default_backend http_router_loop

# ========== Xray WS/GRPC - HTTPS
frontend ssl_front
    mode tcp
    bind *:443,*:2053,*:2087,*:2096 ssl crt /etc/xray/xray.pem alpn h2,http/1.1
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 }
    default_backend http_router_loop

# ========== Router untuk Xray
backend http_router_loop
    mode http
    server internal 127.0.0.1:445 send-proxy-v2

frontend http_router
    mode http
    bind 127.0.0.1:445

    acl is_websocket hdr(Upgrade) -i websocket
    acl path_vless      path_beg /vless
    acl path_vmess      path_beg /vmess
    acl path_trojan_ws  path_beg /trojan-ws
    acl path_ss_ws      path_beg /ss-ws
    acl path_vless_grpc   path_beg /vless-grpc
    acl path_vmess_grpc   path_beg /vmess-grpc
    acl path_trojan_grpc  path_beg /trojan-grpc
    acl path_ss_grpc      path_beg /ss-grpc

    # gRPC
    use_backend xray_vless_grpc_back   if path_vless_grpc
    use_backend xray_vmess_grpc_back   if path_vmess_grpc
    use_backend xray_trojan_grpc_back  if path_trojan_grpc
    use_backend xray_ss_grpc_back      if path_ss_grpc

    # WebSocket
    use_backend xray_vless_ws_back   if is_websocket path_vless
    use_backend xray_vmess_ws_back   if is_websocket path_vmess
    use_backend xray_trojan_ws_back  if is_websocket path_trojan_ws
    use_backend xray_ss_ws_back      if is_websocket path_ss_ws

# ========== BACKENDS XRAY WS
backend xray_vless_ws_back
    mode http
    server xray_vless_ws_server 127.0.0.1:10001

backend xray_vmess_ws_back
    mode http
    server xray_vmess_ws_server 127.0.0.1:10002

backend xray_trojan_ws_back
    mode http
    server xray_trojan_ws_server 127.0.0.1:10003

backend xray_ss_ws_back
    mode http
    server xray_ss_ws_server 127.0.0.1:10004

# ========== BACKENDS XRAY gRPC
backend xray_vless_grpc_back
    mode http
    server xray_vless_grpc_server 127.0.0.1:10005 proto h2

backend xray_vmess_grpc_back
    mode http
    server xray_vmess_grpc_server 127.0.0.1:10006 proto h2

backend xray_trojan_grpc_back
    mode http
    server xray_trojan_grpc_server 127.0.0.1:10007 proto h2

backend xray_ss_grpc_back
    mode http
    server xray_ss_grpc_server 127.0.0.1:10008 proto h2
